<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }

        input, button, select {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover { background-color: #0056b3; }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 12px;
        }
        .message {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .sent { background-color: #e3f2fd; }
        .received { background-color: #e8f5e8; }
        .system { background-color: #fff3e0; }
        .error { background-color: #ffebee; color: #c62828; }

        .users {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            min-height: 30px;
        }
        .user {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        .user.online { background-color: #c8e6c9; }
        .user.offline { background-color: #ffcdd2; }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-group input {
            flex: 1;
        }
    </style>
</head>
<body>
<h1>WebSocket Chat Test Client</h1>

<div class="container">
    <h3>Connection</h3>
    <div id="status" class="status disconnected">Disconnected</div>
    <div class="input-group">
        <input type="text" id="serverUrl" value="ws://localhost:8080/chat" placeholder="WebSocket URL">
        <input type="text" id="username" placeholder="Username" value="testuser1">
    </div>
    <button id="connectBtn" onclick="connect()">Connect</button>
    <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
</div>

<div class="container">
    <h3>Send Message</h3>
    <div class="input-group">
        <input type="text" id="recipient" placeholder="Recipient username" value="testuser2">
        <input type="text" id="messageContent" placeholder="Message content">
    </div>
    <button id="sendBtn" onclick="sendMessage()" disabled>Send Message</button>
    <button id="getMessagesBtn" onclick="getMessages()" disabled>Get Messages</button>
</div>

<div class="container">
    <h3>Presence</h3>
    <button id="onlineBtn" onclick="setPresence(true)" disabled>Set Online</button>
    <button id="offlineBtn" onclick="setPresence(false)" disabled>Set Offline</button>
</div>

<div class="container">
    <h3>Task Testing</h3>
    <div class="input-group">
        <input type="text" id="taskTitle" placeholder="Task title" value="Complete urgent report">
        <input type="text" id="taskAssignee" placeholder="Assignee" value="testuser1">
    </div>
    <button id="createTaskBtn" onclick="createTestTask()" disabled>Create Test Task (10s deadline)</button>
    <button id="getPendingTasksBtn" onclick="getPendingTasks()" disabled>Get Pending Tasks</button>
</div>

<div class="container">
    <h3>Messages</h3>
    <div id="messages" class="messages"></div>
    <button onclick="clearMessages()">Clear Messages</button>
</div>

<div class="container">
    <h3>Online Users</h3>
    <div id="users" class="users"></div>
</div>

<script>
    let socket = null;
    let username = null;
    const onlineUsers = new Map();

    function updateStatus(message, className) {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = 'status ' + className;
    }

    function addMessage(content, type = 'system') {
        const messagesEl = document.getElementById('messages');
        const messageEl = document.createElement('div');
        messageEl.className = 'message ' + type;
        messageEl.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${content}`;
        messagesEl.appendChild(messageEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function updateButtons(connected) {
        document.getElementById('connectBtn').disabled = connected;
        document.getElementById('disconnectBtn').disabled = !connected;
        document.getElementById('sendBtn').disabled = !connected;
        document.getElementById('getMessagesBtn').disabled = !connected;
        document.getElementById('onlineBtn').disabled = !connected;
        document.getElementById('offlineBtn').disabled = !connected;
        document.getElementById('createTaskBtn').disabled = !connected;
        document.getElementById('getPendingTasksBtn').disabled = !connected;
    }

    function updateUsers() {
        const usersEl = document.getElementById('users');
        usersEl.innerHTML = '';
        onlineUsers.forEach((online, user) => {
            const userEl = document.createElement('div');
            userEl.className = 'user ' + (online ? 'online' : 'offline');
            userEl.textContent = user + (online ? ' (online)' : ' (offline)');
            usersEl.appendChild(userEl);
        });
    }

    function connect() {
        const serverUrl = document.getElementById('serverUrl').value;
        username = document.getElementById('username').value;

        if (!username) {
            alert('Please enter a username');
            return;
        }

        updateStatus('Connecting...', 'connecting');
        socket = new WebSocket(serverUrl);

        socket.onopen = function() {
            updateStatus('Connected', 'connected');
            updateButtons(true);
            addMessage('Connected to server', 'system');

            send({
                type: 'register',
                username: username
            });
        };

        socket.onmessage = function(event) {
            try {
                const message = JSON.parse(event.data);
                handleMessage(message);
            } catch (error) {
                addMessage('Error parsing message: ' + error.message, 'error');
            }
        };

        socket.onclose = function(event) {
            updateStatus('Disconnected', 'disconnected');
            updateButtons(false);
            addMessage(`Connection closed: ${event.code} - ${event.reason}`, 'system');
        };

        socket.onerror = function(error) {
            addMessage('WebSocket error occurred', 'error');
            console.error('WebSocket error:', error);
        };
    }

    function disconnect() {
        if (socket) {
            socket.close();
            socket = null;
        }
    }

    function send(message) {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(message));
            addMessage('SENT: ' + JSON.stringify(message, null, 2), 'sent');
        } else {
            addMessage('Cannot send - not connected', 'error');
        }
    }

    function sendMessage() {
        const recipient = document.getElementById('recipient').value;
        const content = document.getElementById('messageContent').value;

        if (!recipient || !content) {
            alert('Please enter recipient and message content');
            return;
        }

        send({
            type: 'send_message',
            recipient: recipient,
            content: content,
            tempId: Date.now().toString()
        });

        document.getElementById('messageContent').value = '';
    }

    function getMessages() {
        send({
            type: 'get_messages'
        });
    }

    function setPresence(online) {
        send({
            type: 'presence',
            online: online
        });
    }

    function createTestTask() {
        const taskTitle = document.getElementById('taskTitle').value;
        const assignee = document.getElementById('taskAssignee').value;

        if (!taskTitle || !assignee) {
            alert('Please enter task title and assignee');
            return;
        }

        // Create a deadline 10 seconds from now
        const deadline = new Date();
        deadline.setSeconds(deadline.getSeconds() + 10);
        const deadlineISO = deadline.toISOString();

        const messages = [
            {
                sender: username,
                content: `Please ${taskTitle} by ${deadlineISO}`
            },
            {
                sender: assignee,
                content: "I'll work on it"
            }
        ];

        fetch('http://localhost:8080/api/tasks/extract', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: messages
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Failed to create task: ' + response.status);
        })
        .then(task => {
            addMessage(`‚úÖ Task created successfully: "${task.taskTitle}" for ${task.assignee}, deadline: ${task.deadline}`, 'system');
            addMessage(`‚è∞ Task notification should arrive in ~10 seconds`, 'system');
        })
        .catch(error => {
            addMessage(`‚ùå Error creating task: ${error.message}`, 'error');
            console.error('Error creating task:', error);
        });
    }

    function getPendingTasks() {
        send({
            type: 'get_pending_tasks'
        });
    }

    function handleMessage(message) {
        addMessage('RECEIVED: ' + JSON.stringify(message, null, 2), 'received');

        switch (message.type) {
            case 'registration_success':
                addMessage(`Successfully registered as ${message.username}`, 'system');
                onlineUsers.set(message.username, true);
                updateUsers();
                break;

            case 'new_message':
                addMessage(`üí¨ Message from ${message.sender}: "${message.content}"`, 'received');
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'message_ack',
                        messageId: message.id
                    }));
                }
                break;

            case 'messages_history':
                addMessage(`üìú Loaded ${message.messages.length} historical messages`, 'system');
                message.messages.forEach(msg => {
                    addMessage(`üìú History: ${msg.sender} -> ${msg.recipient}: "${msg.content}" (${new Date(msg.timestamp).toLocaleString()})`, 'system');
                });
                break;

            case 'message_sent':
                const deliveryStatus = message.delivered ? '‚úÖ delivered' : '‚ùå not delivered';
                addMessage(`Message sent (ID: ${message.messageId}) - ${deliveryStatus}`, 'system');
                break;

            case 'user_presence':
                onlineUsers.set(message.username, message.online);
                updateUsers();
                const status = message.online ? 'came online' : 'went offline';
                addMessage(`üë§ ${message.username} ${status}`, 'system');
                break;

            case 'error':
                addMessage(`‚ùå Server error: ${message.message}`, 'error');
                break;

            case 'pending_tasks':
                addMessage(`üìã Loaded ${message.tasks.length} pending tasks`, 'system');
                message.tasks.forEach(task => {
                    addMessage(`üìã Task: ${task.taskTitle} (Due: ${task.deadline}) - Assigned by: ${task.assignedBy}`, 'system');
                });
                break;

            case 'deadline_notification':
                addMessage(`üö® DEADLINE ALERT: ${message.message}`, 'error');
                addMessage(`üìã Task: "${message.taskTitle}" | Assignee: ${message.assignee} | Assigned by: ${message.assignedBy}`, 'error');
                if (Notification.permission === 'granted') {
                    new Notification('Task Deadline Alert', {
                        body: message.message,
                        icon: '‚è∞'
                    });
                }
                break;

            case 'custom_notification':
                addMessage(`üîî Notification: ${message.message}`, 'system');
                break;

            default:
                addMessage(`‚ùì Unknown message type: ${message.type}`, 'system');
        }
    }

    function clearMessages() {
        document.getElementById('messages').innerHTML = '';
    }

    window.addEventListener('beforeunload', function() {
        if (socket) {
            send({
                type: 'presence',
                online: false
            });
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('messageContent').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    });
</script>


</body>
</html>